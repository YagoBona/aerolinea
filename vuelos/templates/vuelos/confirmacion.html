{% extends 'vuelos/base.html' %}
{% block contenido %}
<div class="ticket mt-5" style="background:white; padding:32px 24px; max-width:520px; margin:auto; border-radius:18px; box-shadow:0 4px 24px rgba(255,152,0,0.10), 0 1.5px 0 #ff9800; border:none; position:relative; overflow:hidden;">
  <h2 style="text-align:center; color:#ff9800; font-size:2.1rem; margin-bottom:1.2rem; letter-spacing:1px;"><i class="bi bi-airplane"></i> Boleto Electrónico</h2>
  <div class="data" style="margin:12px 0; font-size:1.08rem; display:flex; align-items:center; gap:8px;"><i class="bi bi-person"></i> <strong style="min-width:120px; color:#ff9800; font-weight:500;">Pasajero:</strong> {{ reserva.pasajero.nombre }}</div>
  <div class="data" style="margin:12px 0; font-size:1.08rem; display:flex; align-items:center; gap:8px;"><i class="bi bi-card-text"></i> <strong style="min-width:120px; color:#ff9800; font-weight:500;">Documento:</strong> {{ reserva.pasajero.documento }}</div>
  <div class="data" style="margin:12px 0; font-size:1.08rem; display:flex; align-items:center; gap:8px;"><i class="bi bi-geo-alt"></i> <strong style="min-width:120px; color:#ff9800; font-weight:500;">Vuelo:</strong> {{ reserva.vuelo.origen }} → {{ reserva.vuelo.destino }}</div>
  <div class="data" style="margin:12px 0; font-size:1.08rem; display:flex; align-items:center; gap:8px;"><i class="bi bi-calendar-event"></i> <strong style="min-width:120px; color:#ff9800; font-weight:500;">Fecha:</strong> {{ reserva.vuelo.fecha_salida|date:"d/m/Y H:i" }}</div>
  <div class="data" style="margin:12px 0; font-size:1.08rem; display:flex; align-items:center; gap:8px;"><i class="bi bi-grid-3x3-gap"></i> <strong style="min-width:120px; color:#ff9800; font-weight:500;">Asiento:</strong> {{ reserva.asiento.numero }}</div>
  <div class="codigo" style="background:#fff4e3; border-radius:8px; padding:8px 12px; font-size:1.1rem; text-align:center; margin:18px 0 0 0; letter-spacing:1px; color:#ff9800; font-weight:600;"><i class="bi bi-hash"></i> Código Reserva: {{ reserva.codigo_reserva }}</div>
  <div class="codigo" style="background:#fff4e3; border-radius:8px; padding:8px 12px; font-size:1.1rem; text-align:center; margin:10px 0 0 0; letter-spacing:1px; color:#ff9800; font-weight:600;"><i class="bi bi-upc"></i> Código Boleto: {{ boleto.codigo_barra }}</div>
  <div id="qrcode" style="margin-top:18px; text-align:center;"></div>
  <div class="print-btn" style="display:flex; justify-content:center; margin-top:28px; gap:10px;">
    <button onclick="descargarPDF()" class="btn btn-success rounded-pill px-4"><i class="bi bi-file-earmark-pdf"></i> Descargar PDF</button>
    <a href="{% url 'mis_reservas' %}" class="btn btn-outline-primary rounded-pill px-4"><i class="bi bi-ticket-perforated"></i> Mis reservas</a>
    <a href="{% url 'imprimir_boleto' reserva.codigo_reserva %}" class="btn btn-primary rounded-pill px-4"><i class="bi bi-printer"></i> Imprimir boleto</a>
  </div>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
  const qr = new QRCode(document.getElementById("qrcode"), {
    text: "{{ request.build_absolute_uri }}",
    width: 128,
    height: 128
  });
</script>
<!-- jsPDF CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  window.jsPDF = window.jspdf.jsPDF;
  function descargarPDF() {
    // Boarding pass horizontal (landscape) estilo profesional
    const doc = new jsPDF('l', 'mm', 'a5'); // horizontal, tamaño medio
    // Colores
    const naranja = [255,152,0];
    const crema = [255,247,237];
    const gris = [120,120,120];
    // Fondo
    doc.setFillColor(...crema);
    doc.rect(0, 0, 210, 148, 'F');
    // Card principal
    const cardX = 10, cardY = 12, cardW = 190, cardH = 124;
    doc.setFillColor(255,255,255);
    doc.roundedRect(cardX, cardY, cardW, cardH, 10, 10, 'F');
    doc.setDrawColor(...naranja);
    doc.setLineWidth(1.2);
    doc.roundedRect(cardX, cardY, cardW, cardH, 10, 10, 'S');

    // Header naranja
    doc.setFillColor(...naranja);
    doc.roundedRect(cardX, cardY, cardW, 28, 10, 10, 'F');
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(255,255,255);
    doc.setFontSize(20);
    doc.text('BOLETO ELECTRÓNICO', cardX+cardW/2, cardY+18, {align:'center'});

    // Datos principales (lado izquierdo, solo pasajero y documento arriba)
    doc.setFontSize(12);
    doc.setTextColor(...gris);
    let left = cardX+14, top = cardY+38, lh = 9;
    doc.setFont('helvetica', 'normal');
    doc.text('Pasajero:', left, top);
    doc.text('Documento:', left, top+lh);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0,0,0);
    doc.text(`{{ reserva.pasajero.nombre }}`, left+38, top);
    doc.text(`{{ reserva.pasajero.documento }}`, left+38, top+lh);

    // Datos de vuelo, fecha y asiento más abajo, alineados a la izquierda
    let infoY = cardY+72;
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(12);
    doc.setTextColor(...gris);
    doc.text('Vuelo:', left, infoY);
    doc.text('Fecha:', left, infoY+lh);
    doc.text('Asiento:', left, infoY+lh*2);
    doc.setFont('helvetica', 'bold');
    doc.setTextColor(0,0,0);
    doc.text(`{{ reserva.vuelo.origen }} Hacia {{ reserva.vuelo.destino }}`, left+38, infoY);
    doc.text(`{{ reserva.vuelo.fecha_salida|date:'d/m/Y H:i' }}`, left+38, infoY+lh);
    doc.text(`{{ reserva.asiento.numero }}`, left+38, infoY+lh*2);

    // Códigos (lado derecho, arriba, más compactos)
    let right = cardX+cardW-90, codeY = cardY+38;
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10.5);
    // Código reserva
    doc.setFillColor(255,244,227);
    doc.roundedRect(right, codeY-7, 80, 11, 5, 5, 'F');
    doc.setTextColor(...naranja);
    doc.text(`# Reserva: {{ reserva.codigo_reserva }}`, right+40, codeY+1, {align:'center', maxWidth: 76});
    // Código boleto
    doc.setFillColor(...naranja);
    doc.roundedRect(right, codeY+6, 80, 11, 5, 5, 'F');
    doc.setTextColor(255,255,255);
    doc.text(`Boleto: {{ boleto.codigo_barra }}`, right+40, codeY+13, {align:'center', maxWidth: 76});

    // Línea divisoria
    doc.setDrawColor(230,230,230);
    doc.setLineWidth(0.7);
    doc.line(cardX+10, cardY+65, cardX+cardW-10, cardY+65);

    // QR más chico y alineado abajo a la derecha
    const qrEl = document.querySelector('#qrcode img');
    let qrSize = 36;
    let qrX = cardX+cardW-qrSize-18;
    let qrY = cardY+cardH-qrSize-16;
    if(qrEl){
      doc.addImage(qrEl.src, 'PNG', qrX, qrY, qrSize, qrSize);
    }
    // Mensaje final, alineado a la izquierda y más arriba
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(10);
    doc.setTextColor(...gris);
    doc.text('Presentar este boleto en formato digital o impreso al embarcar.', cardX+16, cardY+cardH-18, {maxWidth: cardW-qrSize-40});

    // Branding
    doc.setFontSize(9);
    doc.setTextColor(200,200,200);
    doc.text('Aerolíneas Yager', cardX+cardW-40, cardY+cardH-6, {align:'right'});

    doc.save('boleto_{{ boleto.codigo_barra }}.pdf');
  }
</script>
{% endblock %}
